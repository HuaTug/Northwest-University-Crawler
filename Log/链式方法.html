<div class="article">            <div class="inner">              <header class="article-header">                <h1 class="article-title" itemprop="name">链式方法</h1>                                <a target="_blank" rel="noopener" href="https://translate.gorm.io/project/go-gorm/zh-CN" class="article-edit-link" title="改进此页面"><i class="fa fa-pencil"></i></a>                              </header>              <div class="article-content" itemprop="articleBody">                <html><head></head><body><p>GORM 允许进行链式操作，所以您可以像这样写代码：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Where(<span class="string">"name = ?"</span>, <span class="string">"jinzhu"</span>).Where(<span class="string">"age = ?"</span>, <span class="number">18</span>).First(&amp;user)</span><br></pre></td></tr></tbody></table></figure><p>GORM 中有三种类型的方法： <code>链式方法</code>、<code>终结方法</code>、<code>新建会话方法</code></p><p>在 <code>链式方法</code>, <code>终结方法</code>之后, GORM 返回一个初始化的 <code>*gorm.DB</code> 实例，实例不能安全地重复使用，并且新生成的 SQL 可能会被先前的条件污染，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">queryDB := DB.Where(<span class="string">"name = ?"</span>, <span class="string">"jinzhu"</span>)</span><br><span class="line"></span><br><span class="line">queryDB.Where(<span class="string">"age &gt; ?"</span>, <span class="number">10</span>).First(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = "jinzhu" AND age &gt; 10</span></span><br><span class="line"></span><br><span class="line">queryDB.Where(<span class="string">"age &gt; ?"</span>, <span class="number">20</span>).First(&amp;user2)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = "jinzhu" AND age &gt; 10 AND age &gt; 20</span></span><br></pre></td></tr></tbody></table></figure><p>为了重新使用初始化的 <code>*gorm.DB</code> 实例, 您可以使用 <code>新建会话方法</code> 创建一个可共享的 <code>*gorm.DB</code>, 例如:</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">queryDB := DB.Where(<span class="string">"name = ?"</span>, <span class="string">"jinzhu"</span>).Session(&amp;gorm.Session{})</span><br><span class="line"></span><br><span class="line">queryDB.Where(<span class="string">"age &gt; ?"</span>, <span class="number">10</span>).First(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = "jinzhu" AND age &gt; 10</span></span><br><span class="line"></span><br><span class="line">queryDB.Where(<span class="string">"age &gt; ?"</span>, <span class="number">20</span>).First(&amp;user2)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = "jinzhu" AND age &gt; 20</span></span><br></pre></td></tr></tbody></table></figure><h2 id="链式方法" class="article-heading"><a href="#链式方法" class="headerlink" title="链式方法"></a>链式方法<a class="article-anchor" href="#链式方法" aria-hidden="true"></a></h2><p>链式方法是将 <code>Clauses</code> 修改或添加到当前 <code>Statement</code> 的方法，例如：</p><p><code>Where</code>, <code>Select</code>, <code>Omit</code>, <code>Joins</code>, <code>Scopes</code>, <code>Preload</code>, <code>Raw</code> (<code>Raw</code> can’t be used with other chainable methods to build SQL)…</p><p>这是 <a target="_blank" rel="noopener" href="https://github.com/go-gorm/gorm/blob/master/chainable_api.go">完整方法列表</a>，也可以查看 <a href="sql_builder.html">SQL 构建器</a> 获取更多关于 <code>Clauses</code> 的信息</p><h2 id="终结方法" class="article-heading"><a href="#终结方法" class="headerlink" title="终结方法"></a><span id="finisher_method">终结方法</span><a class="article-anchor" href="#终结方法" aria-hidden="true"></a></h2><p>终结（方法） 是会立即执行注册回调的方法，然后生成并执行 SQL，比如这些方法：</p><p><code>Create</code>, <code>First</code>, <code>Find</code>, <code>Take</code>, <code>Save</code>, <code>Update</code>, <code>Delete</code>, <code>Scan</code>, <code>Row</code>, <code>Rows</code>…</p><p>查看<a target="_blank" rel="noopener" href="https://github.com/go-gorm/gorm/blob/master/finisher_api.go">完整方法列表</a></p><h2 id="新建会话方法" class="article-heading"><a href="#新建会话方法" class="headerlink" title="新建会话方法"></a><span id="goroutine_safe">新建会话方法</span><a class="article-anchor" href="#新建会话方法" aria-hidden="true"></a></h2><p>GORM 定义了 <code>Session</code>、<code>WithContext</code>、<code>Debug</code> 方法做为 <code>新建会话方法</code>，查看<a href="session.html">会话</a> 获取详情.</p><p>在 <code>链式方法</code>, <code>Finisher 方法</code>之后, GORM 返回一个初始化的 <code>*gorm.DB</code> 实例，不能安全地再使用。您应该使用 <code>新建会话方法</code> 来标记 <code>*gorm.DB</code> 为可共享。</p><p>让我们用实例来解释它：</p><p>示例 1：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db, err := gorm.Open(sqlite.Open(<span class="string">"test.db"</span>), &amp;gorm.Config{})</span><br><span class="line"><span class="comment">// db is a new initialized `*gorm.DB`, which is safe to reuse</span></span><br><span class="line"></span><br><span class="line">db.Where(<span class="string">"name = ?"</span>, <span class="string">"jinzhu"</span>).Where(<span class="string">"age = ?"</span>, <span class="number">18</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// `Where("name = ?", "jinzhu")` is the first chain method call, it will create an initialized `*gorm.DB` instance, aka `*gorm.Statement`</span></span><br><span class="line"><span class="comment">// `Where("age = ?", 18)` is the second chain method call, it reuses the above `*gorm.Statement`, adds new condition `age = 18` to it</span></span><br><span class="line"><span class="comment">// `Find(&amp;users)` is a finisher method, it executes registered Query Callbacks, which generates and runs the following SQL:</span></span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = 'jinzhu' AND age = 18;</span></span><br><span class="line"></span><br><span class="line">db.Where(<span class="string">"name = ?"</span>, <span class="string">"jinzhu2"</span>).Where(<span class="string">"age = ?"</span>, <span class="number">20</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// `Where("name = ?", "jinzhu2")` is also the first chain method call, it creates a new `*gorm.Statement`</span></span><br><span class="line"><span class="comment">// `Where("age = ?", 20)` reuses the above `Statement`, and add conditions to it</span></span><br><span class="line"><span class="comment">// `Find(&amp;users)` is a finisher method, it executes registered Query Callbacks, generates and runs the following SQL:</span></span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = 'jinzhu2' AND age = 20;</span></span><br><span class="line"></span><br><span class="line">db.Find(&amp;users)</span><br><span class="line"><span class="comment">// `Find(&amp;users)` is a finisher method call, it also creates a new `Statement` and executes registered Query Callbacks, generates and runs the following SQL:</span></span><br><span class="line"><span class="comment">// SELECT * FROM users;</span></span><br></pre></td></tr></tbody></table></figure><p>(错误的) 示例2：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db, err := gorm.Open(sqlite.Open(<span class="string">"test.db"</span>), &amp;gorm.Config{})</span><br><span class="line"><span class="comment">// db is a new initialized *gorm.DB, which is safe to reuse</span></span><br><span class="line"></span><br><span class="line">tx := db.Where(<span class="string">"name = ?"</span>, <span class="string">"jinzhu"</span>)</span><br><span class="line"><span class="comment">// `Where("name = ?", "jinzhu")` returns an initialized `*gorm.Statement` instance after chain method `Where`, which is NOT safe to reuse</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// good case</span></span><br><span class="line">tx.Where(<span class="string">"age = ?"</span>, <span class="number">18</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// `tx.Where("age = ?", 18)` use the above `*gorm.Statement`, adds new condition to it</span></span><br><span class="line"><span class="comment">// `Find(&amp;users)` is a finisher method call, it executes registered Query Callbacks, generates and runs the following SQL:</span></span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = 'jinzhu' AND age = 18</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// bad case</span></span><br><span class="line">tx.Where(<span class="string">"age = ?"</span>, <span class="number">28</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// `tx.Where("age = ?", 28)` also use the above `*gorm.Statement`, and keep adding conditions to it</span></span><br><span class="line"><span class="comment">// So the following generated SQL is polluted by the previous conditions:</span></span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = 'jinzhu' AND age = 18 AND age = 28;</span></span><br></pre></td></tr></tbody></table></figure><p>示例 3：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db, err := gorm.Open(sqlite.Open(<span class="string">"test.db"</span>), &amp;gorm.Config{})</span><br><span class="line"><span class="comment">// db is a new initialized *gorm.DB, which is safe to reuse</span></span><br><span class="line"></span><br><span class="line">tx := db.Where(<span class="string">"name = ?"</span>, <span class="string">"jinzhu"</span>).Session(&amp;gorm.Session{})</span><br><span class="line">tx := db.Where(<span class="string">"name = ?"</span>, <span class="string">"jinzhu"</span>).WithContext(context.Background())</span><br><span class="line">tx := db.Where(<span class="string">"name = ?"</span>, <span class="string">"jinzhu"</span>).Debug()</span><br><span class="line"><span class="comment">// `Session`, `WithContext`, `Debug` returns `*gorm.DB` marked as safe to reuse, newly initialized `*gorm.Statement` based on it keeps current conditions</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// good case</span></span><br><span class="line">tx.Where(<span class="string">"age = ?"</span>, <span class="number">18</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = 'jinzhu' AND age = 18</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// good case</span></span><br><span class="line">tx.Where(<span class="string">"age = ?"</span>, <span class="number">28</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = 'jinzhu' AND age = 28;</span></span><br></pre></td></tr></tbody></table></figure></body></html>              </div>