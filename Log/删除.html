<div class="article">            <div class="inner">              <header class="article-header">                <h1 class="article-title" itemprop="name">删除</h1>                                <a target="_blank" rel="noopener" href="https://translate.gorm.io/project/go-gorm/zh-CN" class="article-edit-link" title="改进此页面"><i class="fa fa-pencil"></i></a>                              </header>              <div class="article-content" itemprop="articleBody">                <html><head></head><body><h2 id="删除一条记录" class="article-heading"><a href="#删除一条记录" class="headerlink" title="删除一条记录"></a>删除一条记录<a class="article-anchor" href="#删除一条记录" aria-hidden="true"></a></h2><p>删除一条记录时，删除对象需要指定主键，否则会触发 <a href="#batch_delete">批量删除</a>，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// Email 的 ID 是 `10`</span></span><br><span class="line">db.Delete(&amp;email)</span><br><span class="line"><span class="comment">// DELETE from emails where id = 10;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 带额外条件的删除</span></span><br><span class="line">db.Where(<span class="string">"name = ?"</span>, <span class="string">"jinzhu"</span>).Delete(&amp;email)</span><br><span class="line"><span class="comment">// DELETE from emails where id = 10 AND name = "jinzhu";</span></span><br></pre></td></tr></tbody></table></figure><h2 id="根据主键删除" class="article-heading"><a href="#根据主键删除" class="headerlink" title="根据主键删除"></a>根据主键删除<a class="article-anchor" href="#根据主键删除" aria-hidden="true"></a></h2><p>GORM 允许通过主键(可以是复合主键)和内联条件来删除对象，它可以使用数字（如以下例子。也可以使用字符串——译者注）。查看 <a href="query.html#inline_conditions">查询-内联条件（Query Inline Conditions）</a> 了解详情。</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Delete(&amp;User{}, <span class="number">10</span>)</span><br><span class="line"><span class="comment">// DELETE FROM users WHERE id = 10;</span></span><br><span class="line"></span><br><span class="line">db.Delete(&amp;User{}, <span class="string">"10"</span>)</span><br><span class="line"><span class="comment">// DELETE FROM users WHERE id = 10;</span></span><br><span class="line"></span><br><span class="line">db.Delete(&amp;users, []<span class="type">int</span>{<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>})</span><br><span class="line"><span class="comment">// DELETE FROM users WHERE id IN (1,2,3);</span></span><br></pre></td></tr></tbody></table></figure><h2 id="钩子函数" class="article-heading"><a href="#钩子函数" class="headerlink" title="钩子函数"></a>钩子函数<a class="article-anchor" href="#钩子函数" aria-hidden="true"></a></h2><p>对于删除操作，GORM 支持 <code>BeforeDelete</code>、<code>AfterDelete</code> Hook，在删除记录时会调用这些方法，查看 <a href="hooks.html">Hook</a> 获取详情</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> BeforeDelete(tx *gorm.DB) (err <span class="type">error</span>) {</span><br><span class="line">    <span class="keyword">if</span> u.Role == <span class="string">"admin"</span> {</span><br><span class="line">        <span class="keyword">return</span> errors.New(<span class="string">"admin user not allowed to delete"</span>)</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="批量删除" class="article-heading"><a href="#批量删除" class="headerlink" title="批量删除"></a><span id="batch_delete">批量删除</span><a class="article-anchor" href="#批量删除" aria-hidden="true"></a></h2><p>如果指定的值不包括主属性，那么 GORM 会执行批量删除，它将删除所有匹配的记录</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Where(<span class="string">"email LIKE ?"</span>, <span class="string">"%jinzhu%"</span>).Delete(&amp;Email{})</span><br><span class="line"><span class="comment">// DELETE from emails where email LIKE "%jinzhu%";</span></span><br><span class="line"></span><br><span class="line">db.Delete(&amp;Email{}, <span class="string">"email LIKE ?"</span>, <span class="string">"%jinzhu%"</span>)</span><br><span class="line"><span class="comment">// DELETE from emails where email LIKE "%jinzhu%";</span></span><br></pre></td></tr></tbody></table></figure><p>可以将一个主键切片传递给<code>Delete</code> 方法，以便更高效的删除数据量大的记录</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> users = []User{{ID: <span class="number">1</span>}, {ID: <span class="number">2</span>}, {ID: <span class="number">3</span>}}</span><br><span class="line">db.Delete(&amp;users)</span><br><span class="line"><span class="comment">// DELETE FROM users WHERE id IN (1,2,3);</span></span><br><span class="line"></span><br><span class="line">db.Delete(&amp;users, <span class="string">"name LIKE ?"</span>, <span class="string">"%jinzhu%"</span>)</span><br><span class="line"><span class="comment">// DELETE FROM users WHERE name LIKE "%jinzhu%" AND id IN (1,2,3); </span></span><br></pre></td></tr></tbody></table></figure><h3 id="阻止全局删除" class="article-heading"><a href="#阻止全局删除" class="headerlink" title="阻止全局删除"></a>阻止全局删除<a class="article-anchor" href="#阻止全局删除" aria-hidden="true"></a></h3><p>当你试图执行不带任何条件的批量删除时，GORM将不会运行并返回<code>ErrMissingWhereClause</code> 错误</p><p>如果一定要这么做，你必须添加一些条件，或者使用原生SQL，或者开启<code>AllowGlobalUpdate</code> 模式，如下例：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Delete(&amp;User{}).Error <span class="comment">// gorm.ErrMissingWhereClause</span></span><br><span class="line"></span><br><span class="line">db.Delete(&amp;[]User{{Name: <span class="string">"jinzhu1"</span>}, {Name: <span class="string">"jinzhu2"</span>}}).Error <span class="comment">// gorm.ErrMissingWhereClause</span></span><br><span class="line"></span><br><span class="line">db.Where(<span class="string">"1 = 1"</span>).Delete(&amp;User{})</span><br><span class="line"><span class="comment">// DELETE FROM `users` WHERE 1=1</span></span><br><span class="line"></span><br><span class="line">db.Exec(<span class="string">"DELETE FROM users"</span>)</span><br><span class="line"><span class="comment">// DELETE FROM users</span></span><br><span class="line"></span><br><span class="line">db.Session(&amp;gorm.Session{AllowGlobalUpdate: <span class="literal">true</span>}).Delete(&amp;User{})</span><br><span class="line"><span class="comment">// DELETE FROM users</span></span><br></pre></td></tr></tbody></table></figure><h3 id="返回删除行的数据" class="article-heading"><a href="#返回删除行的数据" class="headerlink" title="返回删除行的数据"></a>返回删除行的数据<a class="article-anchor" href="#返回删除行的数据" aria-hidden="true"></a></h3><p>返回被删除的数据，仅当数据库支持回写功能时才能正常运行，如下例：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 回写所有的列</span></span><br><span class="line"><span class="keyword">var</span> users []User</span><br><span class="line">DB.Clauses(clause.Returning{}).Where(<span class="string">"role = ?"</span>, <span class="string">"admin"</span>).Delete(&amp;users)</span><br><span class="line"><span class="comment">// DELETE FROM `users` WHERE role = "admin" RETURNING *</span></span><br><span class="line"><span class="comment">// users =&gt; []User{{ID: 1, Name: "jinzhu", Role: "admin", Salary: 100}, {ID: 2, Name: "jinzhu.2", Role: "admin", Salary: 1000}}</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 回写指定的列</span></span><br><span class="line">DB.Clauses(clause.Returning{Columns: []clause.Column{{Name: <span class="string">"name"</span>}, {Name: <span class="string">"salary"</span>}}}).Where(<span class="string">"role = ?"</span>, <span class="string">"admin"</span>).Delete(&amp;users)</span><br><span class="line"><span class="comment">// DELETE FROM `users` WHERE role = "admin" RETURNING `name`, `salary`</span></span><br><span class="line"><span class="comment">// users =&gt; []User{{ID: 0, Name: "jinzhu", Role: "", Salary: 100}, {ID: 0, Name: "jinzhu.2", Role: "", Salary: 1000}}</span></span><br></pre></td></tr></tbody></table></figure><h2 id="软删除" class="article-heading"><a href="#软删除" class="headerlink" title="软删除"></a>软删除<a class="article-anchor" href="#软删除" aria-hidden="true"></a></h2><p>如果你的模型包含了 <code>gorm.DeletedAt</code>字段（该字段也被包含在<code>gorm.Model</code>中），那么该模型将会自动获得软删除的能力！</p><p>当调用<code>Delete</code>时，GORM并不会从数据库中删除该记录，而是将该记录的<code>DeleteAt</code>设置为当前时间，而后的一般查询方法将无法查找到此条记录。</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// user's ID is `111`</span></span><br><span class="line">db.Delete(&amp;user)</span><br><span class="line"><span class="comment">// UPDATE users SET deleted_at="2013-10-29 10:23" WHERE id = 111;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Batch Delete</span></span><br><span class="line">db.Where(<span class="string">"age = ?"</span>, <span class="number">20</span>).Delete(&amp;User{})</span><br><span class="line"><span class="comment">// UPDATE users SET deleted_at="2013-10-29 10:23" WHERE age = 20;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Soft deleted records will be ignored when querying</span></span><br><span class="line">db.Where(<span class="string">"age = 20"</span>).Find(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE age = 20 AND deleted_at IS NULL;</span></span><br></pre></td></tr></tbody></table></figure><p>如果你并不想嵌套<code>gorm.Model</code>，你也可以像下方例子那样开启软删除特性：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">  ID      <span class="type">int</span></span><br><span class="line">  Deleted gorm.DeletedAt</span><br><span class="line">  Name    <span class="type">string</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="查找被软删除的记录" class="article-heading"><a href="#查找被软删除的记录" class="headerlink" title="查找被软删除的记录"></a>查找被软删除的记录<a class="article-anchor" href="#查找被软删除的记录" aria-hidden="true"></a></h3><p>你可以使用<code>Unscoped</code>来查询到被软删除的记录</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Unscoped().Where(<span class="string">"age = 20"</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE age = 20;</span></span><br></pre></td></tr></tbody></table></figure><h3 id="永久删除" class="article-heading"><a href="#永久删除" class="headerlink" title="永久删除"></a>永久删除<a class="article-anchor" href="#永久删除" aria-hidden="true"></a></h3><p>你可以使用 <code>Unscoped</code>来永久删除匹配的记录</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Unscoped().Delete(&amp;order)</span><br><span class="line"><span class="comment">// DELETE FROM orders WHERE id=10;</span></span><br></pre></td></tr></tbody></table></figure><h3 id="删除标志" class="article-heading"><a href="#删除标志" class="headerlink" title="删除标志"></a>删除标志<a class="article-anchor" href="#删除标志" aria-hidden="true"></a></h3><p>默认情况下，<code>gorm.Model</code>使用<code>*time.Time</code>作为<code>DeletedAt</code> 的字段类型，不过软删除插件<code>gorm.io/plugin/soft_delete</code>同时也提供其他的数据格式支持</p><blockquote class="note warn"><p><strong>提示</strong> 当使用DeletedAt创建唯一复合索引时，你必须使用其他的数据类型，例如通过<code>gorm.io/plugin/soft_delete</code>插件将字段类型定义为unix时间戳等等</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"gorm.io/plugin/soft_delete"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">  ID        <span class="type">uint</span></span><br><span class="line">  Name      <span class="type">string</span>                <span class="string">`gorm:"uniqueIndex:udx_name"`</span></span><br><span class="line">  DeletedAt soft_delete.DeletedAt <span class="string">`gorm:"uniqueIndex:udx_name"`</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></blockquote><h4 id="Unix-时间戳" class="article-heading"><a href="#Unix-时间戳" class="headerlink" title="Unix 时间戳"></a>Unix 时间戳<a class="article-anchor" href="#Unix-时间戳" aria-hidden="true"></a></h4><p>使用unix时间戳作为删除标志</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"gorm.io/plugin/soft_delete"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">  ID        <span class="type">uint</span></span><br><span class="line">  Name      <span class="type">string</span></span><br><span class="line">  DeletedAt soft_delete.DeletedAt</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询</span></span><br><span class="line">SELECT * FROM users WHERE deleted_at = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 软删除</span></span><br><span class="line">UPDATE users SET deleted_at = <span class="comment">/* current unix second */</span> WHERE ID = <span class="number">1</span>;</span><br></pre></td></tr></tbody></table></figure><p>你同样可以指定使用毫秒 <code>milli</code>或纳秒 <code>nano</code>作为值，如下例：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">  ID    <span class="type">uint</span></span><br><span class="line">  Name  <span class="type">string</span></span><br><span class="line">  DeletedAt soft_delete.DeletedAt <span class="string">`gorm:"softDelete:milli"`</span></span><br><span class="line">  <span class="comment">// DeletedAt soft_delete.DeletedAt `gorm:"softDelete:nano"`</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询</span></span><br><span class="line">SELECT * FROM users WHERE deleted_at = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 软删除</span></span><br><span class="line">UPDATE users SET deleted_at = <span class="comment">/* current unix milli second or nano second */</span> WHERE ID = <span class="number">1</span>;</span><br></pre></td></tr></tbody></table></figure><h4 id="使用-1-x2F-0-作为-删除标志" class="article-heading"><a href="#使用-1-x2F-0-作为-删除标志" class="headerlink" title="使用 1 / 0 作为 删除标志"></a>使用 <code>1</code> / <code>0</code> 作为 删除标志<a class="article-anchor" href="#使用-1-x2F-0-作为-删除标志" aria-hidden="true"></a></h4><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"gorm.io/plugin/soft_delete"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">  ID    <span class="type">uint</span></span><br><span class="line">  Name  <span class="type">string</span></span><br><span class="line">  IsDel soft_delete.DeletedAt <span class="string">`gorm:"softDelete:flag"`</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询</span></span><br><span class="line">SELECT * FROM users WHERE is_del = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 软删除</span></span><br><span class="line">UPDATE users SET is_del = <span class="number">1</span> WHERE ID = <span class="number">1</span>;</span><br></pre></td></tr></tbody></table></figure><h4 id="混合模式" class="article-heading"><a href="#混合模式" class="headerlink" title="混合模式"></a>混合模式<a class="article-anchor" href="#混合模式" aria-hidden="true"></a></h4><p>混合模式可以使用 <code>0</code>，<code>1</code>或者unix时间戳来标记数据是否被软删除，并同时可以保存被删除时间</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">  ID        <span class="type">uint</span></span><br><span class="line">  Name      <span class="type">string</span></span><br><span class="line">  DeletedAt time.Time</span><br><span class="line">  IsDel     soft_delete.DeletedAt <span class="string">`gorm:"softDelete:flag,DeletedAtField:DeletedAt"`</span> <span class="comment">// use `1` `0`</span></span><br><span class="line">  <span class="comment">// IsDel     soft_delete.DeletedAt `gorm:"softDelete:,DeletedAtField:DeletedAt"` // use `unix second`</span></span><br><span class="line">  <span class="comment">// IsDel     soft_delete.DeletedAt `gorm:"softDelete:nano,DeletedAtField:DeletedAt"` // use `unix nano second`</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询</span></span><br><span class="line">SELECT * FROM users WHERE is_del = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 软删除</span></span><br><span class="line">UPDATE users SET is_del = <span class="number">1</span>, deleted_at = <span class="comment">/* current unix second */</span> WHERE ID = <span class="number">1</span>;</span><br></pre></td></tr></tbody></table></figure></body></html>              </div>