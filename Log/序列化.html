<div class="article">            <div class="inner">              <header class="article-header">                <h1 class="article-title" itemprop="name">序列化</h1>                                <a target="_blank" rel="noopener" href="https://translate.gorm.io/project/go-gorm/zh-CN" class="article-edit-link" title="改进此页面"><i class="fa fa-pencil"></i></a>                              </header>              <div class="article-content" itemprop="articleBody">                <html><head></head><body><p>Serializer 是一个可扩展的接口，允许自定义如何使用数据库对数据进行序列化和反序列化</p><p>GORM 提供了一些默认的序列化器：json、gob、unixtime，这里有一个如何使用它的快速示例</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">    Name        []<span class="type">byte</span>                 <span class="string">`gorm:"serializer:json"`</span></span><br><span class="line">    Roles       Roles                  <span class="string">`gorm:"serializer:json"`</span></span><br><span class="line">    Contracts   <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>{} <span class="string">`gorm:"serializer:json"`</span></span><br><span class="line">    JobInfo     Job                    <span class="string">`gorm:"type:bytes;serializer:gob"`</span></span><br><span class="line">    CreatedTime <span class="type">int64</span>                  <span class="string">`gorm:"serializer:unixtime;type:time"`</span> <span class="comment">// 将 int 作为日期时间存储到数据库中</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Roles []<span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Job <span class="keyword">struct</span> {</span><br><span class="line">    Title    <span class="type">string</span></span><br><span class="line">    Location <span class="type">string</span></span><br><span class="line">    IsIntern <span class="type">bool</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="注册序列化器" class="article-heading"><a href="#注册序列化器" class="headerlink" title="注册序列化器"></a>注册序列化器<a class="article-anchor" href="#注册序列化器" aria-hidden="true"></a></h2><p>一个Serializer需要实现如何对数据进行序列化和反序列化，所以需要实现如下接口</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"gorm.io/gorm/schema"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> SerializerInterface <span class="keyword">interface</span> {</span><br><span class="line">    Scan(ctx context.Context, field *schema.Field, dst reflect.Value, dbValue <span class="keyword">interface</span>{}) <span class="type">error</span></span><br><span class="line">    SerializerValuerInterface</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> SerializerValuerInterface <span class="keyword">interface</span> {</span><br><span class="line">    Value(ctx context.Context, field *schema.Field, dst reflect.Value, fieldValue <span class="keyword">interface</span>{}) (<span class="keyword">interface</span>{}, <span class="type">error</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>例如，默认 JSONSerializer 的实现如下：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// JSONSerializer json序列化器</span></span><br><span class="line"><span class="keyword">type</span> JSONSerializer <span class="keyword">struct</span> {</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现 Scan 方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(JSONSerializer)</span></span> Scan(ctx context.Context, field *Field, dst reflect.Value, dbValue <span class="keyword">interface</span>{}) (err <span class="type">error</span>) {</span><br><span class="line">    fieldValue := reflect.New(field.FieldType)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> dbValue != <span class="literal">nil</span> {</span><br><span class="line">        <span class="keyword">var</span> bytes []<span class="type">byte</span></span><br><span class="line">        <span class="keyword">switch</span> v := dbValue.(<span class="keyword">type</span>) {</span><br><span class="line">        <span class="keyword">case</span> []<span class="type">byte</span>:</span><br><span class="line">            bytes = v</span><br><span class="line">        <span class="keyword">case</span> <span class="type">string</span>:</span><br><span class="line">            bytes = []<span class="type">byte</span>(v)</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> fmt.Errorf(<span class="string">"failed to unmarshal JSONB value: %#v"</span>, dbValue)</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        err = json.Unmarshal(bytes, fieldValue.Interface())</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    field.ReflectValueOf(ctx, dst).Set(fieldValue.Elem())</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现 Value 方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(JSONSerializer)</span></span> Value(ctx context.Context, field *Field, dst reflect.Value, fieldValue <span class="keyword">interface</span>{}) (<span class="keyword">interface</span>{}, <span class="type">error</span>) {</span><br><span class="line">    <span class="keyword">return</span> json.Marshal(fieldValue)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>并使用以下代码注册：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">schema.RegisterSerializer(<span class="string">"json"</span>, JSONSerializer{})</span><br></pre></td></tr></tbody></table></figure><p>注册序列化器后，您可以将其与 <code>serializer</code> 标签一起使用，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">    Name []<span class="type">byte</span> <span class="string">`gorm:"serializer:json"`</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="自定义序列化器类型" class="article-heading"><a href="#自定义序列化器类型" class="headerlink" title="自定义序列化器类型"></a>自定义序列化器类型<a class="article-anchor" href="#自定义序列化器类型" aria-hidden="true"></a></h2><p>你可以通过标签使用已注册的序列化器，你也可以自定义 struct，实现上述的 <code>SerializerInterface</code> 接口，随后便可以直接将其作为字段类型使用，例如：</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> EncryptedString <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ctx: contains request-scoped values</span></span><br><span class="line"><span class="comment">// field: the field using the serializer, contains GORM settings, struct tags</span></span><br><span class="line"><span class="comment">// dst: current model value, `user` in the below example</span></span><br><span class="line"><span class="comment">// dbValue: current field's value in database</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(es *EncryptedString)</span></span> Scan(ctx context.Context, field *schema.Field, dst reflect.Value, dbValue <span class="keyword">interface</span>{}) (err <span class="type">error</span>) {</span><br><span class="line">    <span class="keyword">switch</span> value := dbValue.(<span class="keyword">type</span>) {</span><br><span class="line">    <span class="keyword">case</span> []<span class="type">byte</span>:</span><br><span class="line">        *es = EncryptedString(bytes.TrimPrefix(value, []<span class="type">byte</span>(<span class="string">"hello"</span>)))</span><br><span class="line">    <span class="keyword">case</span> <span class="type">string</span>:</span><br><span class="line">        *es = EncryptedString(strings.TrimPrefix(value, <span class="string">"hello"</span>))</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">"unsupported data %#v"</span>, dbValue)</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// ctx: contains request-scoped values</span></span><br><span class="line"><span class="comment">// field: the field using the serializer, contains GORM settings, struct tags</span></span><br><span class="line"><span class="comment">// dst: current model value, `user` in the below example</span></span><br><span class="line"><span class="comment">// fieldValue: current field's value of the dst</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(es EncryptedString)</span></span> Value(ctx context.Context, field *schema.Field, dst reflect.Value, fieldValue <span class="keyword">interface</span>{}) (<span class="keyword">interface</span>{}, <span class="type">error</span>) {</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"hello"</span> + <span class="type">string</span>(es), <span class="literal">nil</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> {</span><br><span class="line">    gorm.Model</span><br><span class="line">    Password EncryptedString</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">data := User{</span><br><span class="line">    Password: EncryptedString(<span class="string">"pass"</span>),</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">DB.Create(&amp;data)</span><br><span class="line"><span class="comment">// INSERT INTO `serializer_structs` (`password`) VALUES ("hellopass")</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> result User</span><br><span class="line">DB.First(&amp;result, <span class="string">"id = ?"</span>, data.ID)</span><br><span class="line"><span class="comment">// result =&gt; User{</span></span><br><span class="line"><span class="comment">//   Password: EncryptedString("pass"),</span></span><br><span class="line"><span class="comment">// }</span></span><br><span class="line"></span><br><span class="line">DB.Where(User{Password: EncryptedString(<span class="string">"pass"</span>)}).Take(&amp;result)</span><br><span class="line"><span class="comment">// SELECT * FROM `users` WHERE `users`.`password` = "hellopass"</span></span><br></pre></td></tr></tbody></table></figure></body></html>              </div>