<div class="article">            <div class="inner">              <header class="article-header">                <h1 class="article-title" itemprop="name">更新</h1>                                <a target="_blank" rel="noopener" href="https://translate.gorm.io/project/go-gorm/zh-CN" class="article-edit-link" title="改进此页面"><i class="fa fa-pencil"></i></a>                              </header>              <div class="article-content" itemprop="articleBody">                <html><head></head><body><h2 id="保存所有字段" class="article-heading"><a href="#保存所有字段" class="headerlink" title="保存所有字段"></a>保存所有字段<a class="article-anchor" href="#保存所有字段" aria-hidden="true"></a></h2><p><code>Save</code> 会保存所有的字段，即使字段是零值</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.First(&amp;user)</span><br><span class="line"></span><br><span class="line">user.Name = <span class="string">"jinzhu 2"</span></span><br><span class="line">user.Age = <span class="number">100</span></span><br><span class="line">db.Save(&amp;user)</span><br><span class="line"><span class="comment">// UPDATE users SET name='jinzhu 2', age=100, birthday='2016-01-01', updated_at = '2013-11-17 21:34:10' WHERE id=111;</span></span><br></pre></td></tr></tbody></table></figure><p><code>Save</code> is a combination function. If save value does not contain primary key, it will execute <code>Create</code>, otherwise it will execute <code>Update</code> (with all fields).</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Save(&amp;User{Name: <span class="string">"jinzhu"</span>, Age: <span class="number">100</span>})</span><br><span class="line"><span class="comment">// INSERT INTO `users` (`name`,`age`,`birthday`,`update_at`) VALUES ("jinzhu",100,"0000-00-00 00:00:00","0000-00-00 00:00:00")</span></span><br><span class="line"></span><br><span class="line">db.Save(&amp;User{ID: <span class="number">1</span>, Name: <span class="string">"jinzhu"</span>, Age: <span class="number">100</span>})</span><br><span class="line"><span class="comment">// UPDATE `users` SET `name`="jinzhu",`age`=100,`birthday`="0000-00-00 00:00:00",`update_at`="0000-00-00 00:00:00" WHERE `id` = 1</span></span><br></pre></td></tr></tbody></table></figure><blockquote class="note warn"><p><strong>NOTE</strong> Don’t use <code>Save</code> with <code>Model</code>, it’s an <strong>Undefined Behavior</strong>.</p></blockquote><h2 id="更新单个列" class="article-heading"><a href="#更新单个列" class="headerlink" title="更新单个列"></a>更新单个列<a class="article-anchor" href="#更新单个列" aria-hidden="true"></a></h2><p>When updating a single column with <code>Update</code>, it needs to have any conditions or it will raise error <code>ErrMissingWhereClause</code>, checkout <a href="#block_global_updates">Block Global Updates</a> for details. When using the <code>Model</code> method and its value has a primary value, the primary key will be used to build the condition, for example:</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// Update with conditions</span></span><br><span class="line">db.Model(&amp;User{}).Where(<span class="string">"active = ?"</span>, <span class="literal">true</span>).Update(<span class="string">"name"</span>, <span class="string">"hello"</span>)</span><br><span class="line"><span class="comment">// UPDATE users SET name='hello', updated_at='2013-11-17 21:34:10' WHERE active=true;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// User's ID is `111`:</span></span><br><span class="line">db.Model(&amp;user).Update(<span class="string">"name"</span>, <span class="string">"hello"</span>)</span><br><span class="line"><span class="comment">// UPDATE users SET name='hello', updated_at='2013-11-17 21:34:10' WHERE id=111;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Update with conditions and model value</span></span><br><span class="line">db.Model(&amp;user).Where(<span class="string">"active = ?"</span>, <span class="literal">true</span>).Update(<span class="string">"name"</span>, <span class="string">"hello"</span>)</span><br><span class="line"><span class="comment">// UPDATE users SET name='hello', updated_at='2013-11-17 21:34:10' WHERE id=111 AND active=true;</span></span><br></pre></td></tr></tbody></table></figure><h2 id="更新多列" class="article-heading"><a href="#更新多列" class="headerlink" title="更新多列"></a>更新多列<a class="article-anchor" href="#更新多列" aria-hidden="true"></a></h2><p><code>Updates</code> supports updating with <code>struct</code> or <code>map[string]interface{}</code>, when updating with <code>struct</code> it will only update non-zero fields by default</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// Update attributes with `struct`, will only update non-zero fields</span></span><br><span class="line">db.Model(&amp;user).Updates(User{Name: <span class="string">"hello"</span>, Age: <span class="number">18</span>, Active: <span class="literal">false</span>})</span><br><span class="line"><span class="comment">// UPDATE users SET name='hello', age=18, updated_at = '2013-11-17 21:34:10' WHERE id = 111;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Update attributes with `map`</span></span><br><span class="line">db.Model(&amp;user).Updates(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>{}{<span class="string">"name"</span>: <span class="string">"hello"</span>, <span class="string">"age"</span>: <span class="number">18</span>, <span class="string">"active"</span>: <span class="literal">false</span>})</span><br><span class="line"><span class="comment">// UPDATE users SET name='hello', age=18, active=false, updated_at='2013-11-17 21:34:10' WHERE id=111;</span></span><br></pre></td></tr></tbody></table></figure><blockquote class="note warn"><p><strong>NOTE</strong> When updating with struct, GORM will only update non-zero fields. You might want to use <code>map</code> to update attributes or use <code>Select</code> to specify fields to update</p></blockquote><h2 id="更新选定字段" class="article-heading"><a href="#更新选定字段" class="headerlink" title="更新选定字段"></a>更新选定字段<a class="article-anchor" href="#更新选定字段" aria-hidden="true"></a></h2><p>If you want to update selected fields or ignore some fields when updating, you can use <code>Select</code>, <code>Omit</code></p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// Select with Map</span></span><br><span class="line"><span class="comment">// User's ID is `111`:</span></span><br><span class="line">db.Model(&amp;user).Select(<span class="string">"name"</span>).Updates(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>{}{<span class="string">"name"</span>: <span class="string">"hello"</span>, <span class="string">"age"</span>: <span class="number">18</span>, <span class="string">"active"</span>: <span class="literal">false</span>})</span><br><span class="line"><span class="comment">// UPDATE users SET name='hello' WHERE id=111;</span></span><br><span class="line"></span><br><span class="line">db.Model(&amp;user).Omit(<span class="string">"name"</span>).Updates(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>{}{<span class="string">"name"</span>: <span class="string">"hello"</span>, <span class="string">"age"</span>: <span class="number">18</span>, <span class="string">"active"</span>: <span class="literal">false</span>})</span><br><span class="line"><span class="comment">// UPDATE users SET age=18, active=false, updated_at='2013-11-17 21:34:10' WHERE id=111;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Select with Struct (select zero value fields)</span></span><br><span class="line">db.Model(&amp;user).Select(<span class="string">"Name"</span>, <span class="string">"Age"</span>).Updates(User{Name: <span class="string">"new_name"</span>, Age: <span class="number">0</span>})</span><br><span class="line"><span class="comment">// UPDATE users SET name='new_name', age=0 WHERE id=111;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Select all fields (select all fields include zero value fields)</span></span><br><span class="line">db.Model(&amp;user).Select(<span class="string">"*"</span>).Updates(User{Name: <span class="string">"jinzhu"</span>, Role: <span class="string">"admin"</span>, Age: <span class="number">0</span>})</span><br><span class="line"></span><br><span class="line"><span class="comment">// Select all fields but omit Role (select all fields include zero value fields)</span></span><br><span class="line">db.Model(&amp;user).Select(<span class="string">"*"</span>).Omit(<span class="string">"Role"</span>).Updates(User{Name: <span class="string">"jinzhu"</span>, Role: <span class="string">"admin"</span>, Age: <span class="number">0</span>})</span><br></pre></td></tr></tbody></table></figure><h2 id="更新-Hook" class="article-heading"><a href="#更新-Hook" class="headerlink" title="更新 Hook"></a>更新 Hook<a class="article-anchor" href="#更新-Hook" aria-hidden="true"></a></h2><p>GORM allows the hooks <code>BeforeSave</code>, <code>BeforeUpdate</code>, <code>AfterSave</code>, <code>AfterUpdate</code>. Those methods will be called when updating a record, refer <a href="hooks.html">Hooks</a> for details</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> BeforeUpdate(tx *gorm.DB) (err <span class="type">error</span>) {</span><br><span class="line">    <span class="keyword">if</span> u.Role == <span class="string">"admin"</span> {</span><br><span class="line">        <span class="keyword">return</span> errors.New(<span class="string">"admin user not allowed to update"</span>)</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="批量更新" class="article-heading"><a href="#批量更新" class="headerlink" title="批量更新"></a>批量更新<a class="article-anchor" href="#批量更新" aria-hidden="true"></a></h2><p>If we haven’t specified a record having a primary key value with <code>Model</code>, GORM will perform a batch update</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// Update with struct</span></span><br><span class="line">db.Model(User{}).Where(<span class="string">"role = ?"</span>, <span class="string">"admin"</span>).Updates(User{Name: <span class="string">"hello"</span>, Age: <span class="number">18</span>})</span><br><span class="line"><span class="comment">// UPDATE users SET name='hello', age=18 WHERE role = 'admin';</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Update with map</span></span><br><span class="line">db.Table(<span class="string">"users"</span>).Where(<span class="string">"id IN ?"</span>, []<span class="type">int</span>{<span class="number">10</span>, <span class="number">11</span>}).Updates(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>{}{<span class="string">"name"</span>: <span class="string">"hello"</span>, <span class="string">"age"</span>: <span class="number">18</span>})</span><br><span class="line"><span class="comment">// UPDATE users SET name='hello', age=18 WHERE id IN (10, 11);</span></span><br></pre></td></tr></tbody></table></figure><h3 id="阻止全局更新" class="article-heading"><a href="#阻止全局更新" class="headerlink" title="阻止全局更新"></a><span id="block_global_updates">阻止全局更新</span><a class="article-anchor" href="#阻止全局更新" aria-hidden="true"></a></h3><p>If you perform a batch update without any conditions, GORM WON’T run it and will return <code>ErrMissingWhereClause</code> error by default</p><p>You have to use some conditions or use raw SQL or enable the <code>AllowGlobalUpdate</code> mode, for example:</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Model(&amp;User{}).Update(<span class="string">"name"</span>, <span class="string">"jinzhu"</span>).Error <span class="comment">// gorm.ErrMissingWhereClause</span></span><br><span class="line"></span><br><span class="line">db.Model(&amp;User{}).Where(<span class="string">"1 = 1"</span>).Update(<span class="string">"name"</span>, <span class="string">"jinzhu"</span>)</span><br><span class="line"><span class="comment">// UPDATE users SET `name` = "jinzhu" WHERE 1=1</span></span><br><span class="line"></span><br><span class="line">db.Exec(<span class="string">"UPDATE users SET name = ?"</span>, <span class="string">"jinzhu"</span>)</span><br><span class="line"><span class="comment">// UPDATE users SET name = "jinzhu"</span></span><br><span class="line"></span><br><span class="line">db.Session(&amp;gorm.Session{AllowGlobalUpdate: <span class="literal">true</span>}).Model(&amp;User{}).Update(<span class="string">"name"</span>, <span class="string">"jinzhu"</span>)</span><br><span class="line"><span class="comment">// UPDATE users SET `name` = "jinzhu"</span></span><br></pre></td></tr></tbody></table></figure><h3 id="更新的记录数" class="article-heading"><a href="#更新的记录数" class="headerlink" title="更新的记录数"></a>更新的记录数<a class="article-anchor" href="#更新的记录数" aria-hidden="true"></a></h3><p>Get the number of rows affected by a update</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// Get updated records count with `RowsAffected`</span></span><br><span class="line">result := db.Model(User{}).Where(<span class="string">"role = ?"</span>, <span class="string">"admin"</span>).Updates(User{Name: <span class="string">"hello"</span>, Age: <span class="number">18</span>})</span><br><span class="line"><span class="comment">// UPDATE users SET name='hello', age=18 WHERE role = 'admin';</span></span><br><span class="line"></span><br><span class="line">result.RowsAffected <span class="comment">// returns updated records count</span></span><br><span class="line">result.Error        <span class="comment">// returns updating error</span></span><br></pre></td></tr></tbody></table></figure><h2 id="高级选项" class="article-heading"><a href="#高级选项" class="headerlink" title="高级选项"></a>高级选项<a class="article-anchor" href="#高级选项" aria-hidden="true"></a></h2><h3 id="使用-SQL-表达式更新" class="article-heading"><a href="#使用-SQL-表达式更新" class="headerlink" title="使用 SQL 表达式更新"></a><span id="update_from_sql_expr">使用 SQL 表达式更新</span><a class="article-anchor" href="#使用-SQL-表达式更新" aria-hidden="true"></a></h3><p>GORM allows updating a column with a SQL expression, e.g:</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// product's ID is `3`</span></span><br><span class="line">db.Model(&amp;product).Update(<span class="string">"price"</span>, gorm.Expr(<span class="string">"price * ? + ?"</span>, <span class="number">2</span>, <span class="number">100</span>))</span><br><span class="line"><span class="comment">// UPDATE "products" SET "price" = price * 2 + 100, "updated_at" = '2013-11-17 21:34:10' WHERE "id" = 3;</span></span><br><span class="line"></span><br><span class="line">db.Model(&amp;product).Updates(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>{}{<span class="string">"price"</span>: gorm.Expr(<span class="string">"price * ? + ?"</span>, <span class="number">2</span>, <span class="number">100</span>)})</span><br><span class="line"><span class="comment">// UPDATE "products" SET "price" = price * 2 + 100, "updated_at" = '2013-11-17 21:34:10' WHERE "id" = 3;</span></span><br><span class="line"></span><br><span class="line">db.Model(&amp;product).UpdateColumn(<span class="string">"quantity"</span>, gorm.Expr(<span class="string">"quantity - ?"</span>, <span class="number">1</span>))</span><br><span class="line"><span class="comment">// UPDATE "products" SET "quantity" = quantity - 1 WHERE "id" = 3;</span></span><br><span class="line"></span><br><span class="line">db.Model(&amp;product).Where(<span class="string">"quantity &gt; 1"</span>).UpdateColumn(<span class="string">"quantity"</span>, gorm.Expr(<span class="string">"quantity - ?"</span>, <span class="number">1</span>))</span><br><span class="line"><span class="comment">// UPDATE "products" SET "quantity" = quantity - 1 WHERE "id" = 3 AND quantity &gt; 1;</span></span><br></pre></td></tr></tbody></table></figure><p>And GORM also allows updating with SQL Expression/Context Valuer with <a href="data_types.html#gorm_valuer_interface">Customized Data Types</a>, e.g:</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// Create from customized data type</span></span><br><span class="line"><span class="keyword">type</span> Location <span class="keyword">struct</span> {</span><br><span class="line">    X, Y <span class="type">int</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(loc Location)</span></span> GormValue(ctx context.Context, db *gorm.DB) clause.Expr {</span><br><span class="line">  <span class="keyword">return</span> clause.Expr{</span><br><span class="line">    SQL:  <span class="string">"ST_PointFromText(?)"</span>,</span><br><span class="line">    Vars: []<span class="keyword">interface</span>{}{fmt.Sprintf(<span class="string">"POINT(%d %d)"</span>, loc.X, loc.Y)},</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">db.Model(&amp;User{ID: <span class="number">1</span>}).Updates(User{</span><br><span class="line">  Name:  <span class="string">"jinzhu"</span>,</span><br><span class="line">  Location: Location{X: <span class="number">100</span>, Y: <span class="number">100</span>},</span><br><span class="line">})</span><br><span class="line"><span class="comment">// UPDATE `user_with_points` SET `name`="jinzhu",`location`=ST_PointFromText("POINT(100 100)") WHERE `id` = 1</span></span><br></pre></td></tr></tbody></table></figure><h3 id="根据子查询进行更新" class="article-heading"><a href="#根据子查询进行更新" class="headerlink" title="根据子查询进行更新"></a>根据子查询进行更新<a class="article-anchor" href="#根据子查询进行更新" aria-hidden="true"></a></h3><p>Update a table by using SubQuery</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">db.Model(&amp;user).Update(<span class="string">"company_name"</span>, db.Model(&amp;Company{}).Select(<span class="string">"name"</span>).Where(<span class="string">"companies.id = users.company_id"</span>))</span><br><span class="line"><span class="comment">// UPDATE "users" SET "company_name" = (SELECT name FROM companies WHERE companies.id = users.company_id);</span></span><br><span class="line"></span><br><span class="line">db.Table(<span class="string">"users as u"</span>).Where(<span class="string">"name = ?"</span>, <span class="string">"jinzhu"</span>).Update(<span class="string">"company_name"</span>, db.Table(<span class="string">"companies as c"</span>).Select(<span class="string">"name"</span>).Where(<span class="string">"c.id = u.company_id"</span>))</span><br><span class="line"></span><br><span class="line">db.Table(<span class="string">"users as u"</span>).Where(<span class="string">"name = ?"</span>, <span class="string">"jinzhu"</span>).Updates(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>{}{<span class="string">"company_name"</span>: db.Table(<span class="string">"companies as c"</span>).Select(<span class="string">"name"</span>).Where(<span class="string">"c.id = u.company_id"</span>)})</span><br></pre></td></tr></tbody></table></figure><h3 id="不使用-Hook-和时间追踪" class="article-heading"><a href="#不使用-Hook-和时间追踪" class="headerlink" title="不使用 Hook 和时间追踪"></a>不使用 Hook 和时间追踪<a class="article-anchor" href="#不使用-Hook-和时间追踪" aria-hidden="true"></a></h3><p>If you want to skip <code>Hooks</code> methods and don’t track the update time when updating, you can use <code>UpdateColumn</code>, <code>UpdateColumns</code>, it works like <code>Update</code>, <code>Updates</code></p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// Update single column</span></span><br><span class="line">db.Model(&amp;user).UpdateColumn(<span class="string">"name"</span>, <span class="string">"hello"</span>)</span><br><span class="line"><span class="comment">// UPDATE users SET name='hello' WHERE id = 111;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Update multiple columns</span></span><br><span class="line">db.Model(&amp;user).UpdateColumns(User{Name: <span class="string">"hello"</span>, Age: <span class="number">18</span>})</span><br><span class="line"><span class="comment">// UPDATE users SET name='hello', age=18 WHERE id = 111;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Update selected columns</span></span><br><span class="line">db.Model(&amp;user).Select(<span class="string">"name"</span>, <span class="string">"age"</span>).UpdateColumns(User{Name: <span class="string">"hello"</span>, Age: <span class="number">0</span>})</span><br><span class="line"><span class="comment">// UPDATE users SET name='hello', age=0 WHERE id = 111;</span></span><br></pre></td></tr></tbody></table></figure><h3 id="返回修改行的数据" class="article-heading"><a href="#返回修改行的数据" class="headerlink" title="返回修改行的数据"></a>返回修改行的数据<a class="article-anchor" href="#返回修改行的数据" aria-hidden="true"></a></h3><p>Returning changed data only works for databases which support Returning, for example:</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// return all columns</span></span><br><span class="line"><span class="keyword">var</span> users []User</span><br><span class="line">db.Model(&amp;users).Clauses(clause.Returning{}).Where(<span class="string">"role = ?"</span>, <span class="string">"admin"</span>).Update(<span class="string">"salary"</span>, gorm.Expr(<span class="string">"salary * ?"</span>, <span class="number">2</span>))</span><br><span class="line"><span class="comment">// UPDATE `users` SET `salary`=salary * 2,`updated_at`="2021-10-28 17:37:23.19" WHERE role = "admin" RETURNING *</span></span><br><span class="line"><span class="comment">// users =&gt; []User{{ID: 1, Name: "jinzhu", Role: "admin", Salary: 100}, {ID: 2, Name: "jinzhu.2", Role: "admin", Salary: 1000}}</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// return specified columns</span></span><br><span class="line">db.Model(&amp;users).Clauses(clause.Returning{Columns: []clause.Column{{Name: <span class="string">"name"</span>}, {Name: <span class="string">"salary"</span>}}}).Where(<span class="string">"role = ?"</span>, <span class="string">"admin"</span>).Update(<span class="string">"salary"</span>, gorm.Expr(<span class="string">"salary * ?"</span>, <span class="number">2</span>))</span><br><span class="line"><span class="comment">// UPDATE `users` SET `salary`=salary * 2,`updated_at`="2021-10-28 17:37:23.19" WHERE role = "admin" RETURNING `name`, `salary`</span></span><br><span class="line"><span class="comment">// users =&gt; []User{{ID: 0, Name: "jinzhu", Role: "", Salary: 100}, {ID: 0, Name: "jinzhu.2", Role: "", Salary: 1000}}</span></span><br></pre></td></tr></tbody></table></figure><h3 id="检查字段是否有变更？" class="article-heading"><a href="#检查字段是否有变更？" class="headerlink" title="检查字段是否有变更？"></a>检查字段是否有变更？<a class="article-anchor" href="#检查字段是否有变更？" aria-hidden="true"></a></h3><p>GORM provides the <code>Changed</code> method which could be used in <strong>Before Update Hooks</strong>, it will return whether the field has changed or not.</p><p>The <code>Changed</code> method only works with methods <code>Update</code>, <code>Updates</code>, and it only checks if the updating value from <code>Update</code> / <code>Updates</code> equals the model value. It will return true if it is changed and not omitted</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> BeforeUpdate(tx *gorm.DB) (err <span class="type">error</span>) {</span><br><span class="line">  <span class="comment">// if Role changed</span></span><br><span class="line">    <span class="keyword">if</span> tx.Statement.Changed(<span class="string">"Role"</span>) {</span><br><span class="line">    <span class="keyword">return</span> errors.New(<span class="string">"role not allowed to change"</span>)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> tx.Statement.Changed(<span class="string">"Name"</span>, <span class="string">"Admin"</span>) { <span class="comment">// if Name or Role changed</span></span><br><span class="line">    tx.Statement.SetColumn(<span class="string">"Age"</span>, <span class="number">18</span>)</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// if any fields changed</span></span><br><span class="line">    <span class="keyword">if</span> tx.Statement.Changed() {</span><br><span class="line">        tx.Statement.SetColumn(<span class="string">"RefreshedAt"</span>, time.Now())</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">db.Model(&amp;User{ID: <span class="number">1</span>, Name: <span class="string">"jinzhu"</span>}).Updates(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>{<span class="string">"name"</span>: <span class="string">"jinzhu2"</span>})</span><br><span class="line"><span class="comment">// Changed("Name") =&gt; true</span></span><br><span class="line">db.Model(&amp;User{ID: <span class="number">1</span>, Name: <span class="string">"jinzhu"</span>}).Updates(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>{<span class="string">"name"</span>: <span class="string">"jinzhu"</span>})</span><br><span class="line"><span class="comment">// Changed("Name") =&gt; false, `Name` not changed</span></span><br><span class="line">db.Model(&amp;User{ID: <span class="number">1</span>, Name: <span class="string">"jinzhu"</span>}).Select(<span class="string">"Admin"</span>).Updates(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>{</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"jinzhu2"</span>, <span class="string">"admin"</span>: <span class="literal">false</span>,</span><br><span class="line">})</span><br><span class="line"><span class="comment">// Changed("Name") =&gt; false, `Name` not selected to update</span></span><br><span class="line"></span><br><span class="line">db.Model(&amp;User{ID: <span class="number">1</span>, Name: <span class="string">"jinzhu"</span>}).Updates(User{Name: <span class="string">"jinzhu2"</span>})</span><br><span class="line"><span class="comment">// Changed("Name") =&gt; true</span></span><br><span class="line">db.Model(&amp;User{ID: <span class="number">1</span>, Name: <span class="string">"jinzhu"</span>}).Updates(User{Name: <span class="string">"jinzhu"</span>})</span><br><span class="line"><span class="comment">// Changed("Name") =&gt; false, `Name` not changed</span></span><br><span class="line">db.Model(&amp;User{ID: <span class="number">1</span>, Name: <span class="string">"jinzhu"</span>}).Select(<span class="string">"Admin"</span>).Updates(User{Name: <span class="string">"jinzhu2"</span>})</span><br><span class="line"><span class="comment">// Changed("Name") =&gt; false, `Name` not selected to update</span></span><br></pre></td></tr></tbody></table></figure><h3 id="在-Update-时修改值" class="article-heading"><a href="#在-Update-时修改值" class="headerlink" title="在 Update 时修改值"></a>在 Update 时修改值<a class="article-anchor" href="#在-Update-时修改值" aria-hidden="true"></a></h3><p>To change updating values in Before Hooks, you should use <code>SetColumn</code> unless it is a full update with <code>Save</code>, for example:</p><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(user *User)</span></span> BeforeSave(tx *gorm.DB) (err <span class="type">error</span>) {</span><br><span class="line">  <span class="keyword">if</span> pw, err := bcrypt.GenerateFromPassword(user.Password, <span class="number">0</span>); err == <span class="literal">nil</span> {</span><br><span class="line">    tx.Statement.SetColumn(<span class="string">"EncryptedPassword"</span>, pw)</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> tx.Statement.Changed(<span class="string">"Code"</span>) {</span><br><span class="line">    user.Age += <span class="number">20</span></span><br><span class="line">    tx.Statement.SetColumn(<span class="string">"Age"</span>, user.Age)</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">db.Model(&amp;user).Update(<span class="string">"Name"</span>, <span class="string">"jinzhu"</span>)</span><br></pre></td></tr></tbody></table></figure></body></html>              </div>